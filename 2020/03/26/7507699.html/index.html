<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="GicLYNNqJJ-XBSPlE8Pz-ZwGf2ElS_d_VRcEsQServ4" />
    <meta name="google-site-verification" content="rn4dOdASKHwgOgBKFwN8nAB0OlnuC_pNB8qLDnMyPpc" />
    <meta name="baidu-site-verification" content="093lY4ziMu" />
    <meta name="baidu-site-verification" content="code-W4A0ktcwoi" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="description" content="nojsja 个人博客">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/blogs/img/favicon.ico">

    <!-- pre actions -->
    <link href="/blogs/fonts/fontawesome-webfont.woff2?v=4.3.0" rel=preload as="font" crossorigin>
    <link href="https://www.google-analytics.com" rel="preconnect" crossorigin>
    <link href="http://busuanzi.ibruce.info" rel="preconnect" crossorigin>
    <link href="http://nojsja.gitee.io" rel="preconnect" crossorigin>

    <title>
        
          基于s3对象存储多文件分片上传的Javascript实现（二） - nojsja | Blog
        
    </title>

    <link rel="canonical" href="https://nojsja.github.io/blogs/blogs/2020/03/26/7507699.html/">

    <!-- Bootstrap Core CSS -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS --> 
    
<link rel="stylesheet" href="/blogs/css/dusign-light.css">


    <!-- git markdown code style (will be loaded in post) -->
     
      
<link rel="stylesheet" href="/blogs/css/github-markdown.min.css">

     

    <style>
      .markdown-body {
        box-sizing: border-box;
        min-width: 200px;
        max-width: 980px;
        margin: 0 auto;
        padding: 45px;
      }
    
      @media (max-width: 767px) {
        .markdown-body {
          padding: 15px;
        }
      }
    </style>
    
    
<link rel="stylesheet" href="/blogs/css/widget.css">


    
<link rel="stylesheet" href="/blogs/css/fonts.googleapis.css">


    
<link rel="stylesheet" href="/blogs/css/font-awesome.min.css">


    <!-- polyfill -->
  	<!-- async load function -->

<script>
  function async(u, c, tag, async) {
    var head = document.head ||
      document.getElementsByTagName('head')[0] ||
      document.documentElement;
    var d = document, t = tag || 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    async = ['async', 'defer'].includes(async) ? async : !!async;
    
    switch(t) {
      case 'script':
        o.src = u;
        if (async) o[async] = true;
        break;
      case 'link':
        o.type = "text/css";
        o.href = u;
        o.rel = "stylesheet";
        break;
      default:
        o.src = u;
        break;
    }

    /* callback */

    if (c) { 
      if (o.readyState) {//IE
        o.onreadystatechange = function (e) {
          if (o.readyState == "loaded"
            || o.readyState == "complete") {
            o.onreadystatechange = null;
            c(null, e)();
          }
        };
      } else {//其他浏览器
        o.onload = function (e) {
          c(null, e);
        };
      }
    }

    s.parentNode.insertBefore(o, head.firstChild);
  }
</script>

<!-- xhr -->

<script>
  function sendXMLHttpRequest(options) {
    var url = options.url;
    var method = (options.method || 'get').toUpperCase();
    var callback = options.callback;
    var async = ('async' in options) ? !!options.async : true;
    var xhr = null;

    if (!url) return;

    if (window.XMLHttpRequest) {
      xhr = new XMLHttpRequest();
    } else {
      xhr = new ActiveXObject("Microsoft.XMLHTTP");
    }
    xhr.open(method, url, async);
    xhr.onreadystatechange = function () {
      if (this.readyState === 4) {
        if (callback) callback(this.responseText);
        xhr.onreadystatechange = null;
      }
    };
    xhr.send(null);
  }
    // Ajax 后面的代码
</script>

<!-- fn debounce / throttle -->

<script>

  /**
  * fnDebounce [去抖函数]
  * @author nojsja
  * @param  {Function} fn [需要被包裹的原始函数逻辑]
  * @param  {Numberl} timeout [延迟时间]
  * @return {Function} [高阶函数]
  */
  var fnDebounce = function(fn, timeout) {
    var time = null;

    return function() {
      if (!time) return time = Date.now();
      if (Date.now() - time >= timeout) {
        time = null;
        return fn.apply(this, [].slice.call(arguments));
      } else {
        time = Date.now();
      }
    };
  };

  /**
  * fnThrottle [节流函数]
  * @author nojsja
  * @param  {Function} fn [需要被包裹的原始函数逻辑]
  * @param  {Numberl} timeout [延迟时间]
  * @return {Function} [高阶函数]
  */
  var fnThrottle = function(fn, timeout) {
    var time = null;

    return function() {
      if (!time) return time = Date.now();
      if ((Date.now() - time) >= timeout) {
        time = null;
        return fn.apply(this, [].slice.call(arguments));
      }
    };
  };
</script>

<!-- intersection-observer.js -->

<script>
  if ('IntersectionObserver' in window &&
    'IntersectionObserverEntry' in window &&
    'intersectionRatio' in window.IntersectionObserverEntry.prototype) {

    if (!('isIntersecting' in window.IntersectionObserverEntry.prototype)) {
      Object.defineProperty(window.IntersectionObserverEntry.prototype,
        'isIntersecting', {
        get: function () {
          return this.intersectionRatio > 0;
        }
      });
    }
  } else {
    /* load polyfill sync */
    sendXMLHttpRequest({
      url: '/blogs/js/intersection-observer.js',
      async: false,
      method: 'get',
      callback: function(txt) {
        eval(txt);
      }
    });
  }
</script>

    
<script src="/blogs/js/buttons.js" async defer></script>


<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->
<body>

	<!-- Post Header -->
<style type="text/css">
    header.intro-header {
        
            
                background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('https://nojsja.gitee.io/static-resources/images/hexo/article_header/article_header.jpg')
                /*post*/
            
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/blogs/tags/#upload" title="upload">upload</a>
                            
                              <a class="tag" href="/blogs/tags/#node" title="node">node</a>
                            
                        </div>
                        <h1>基于s3对象存储多文件分片上传的Javascript实现（二）</h1>
                        <h2 class="subheading">fileupload node fs</h2>
                        <span class="meta">
                            <span class="post-description">
                                <i class="fa fa-user" aria-hidden="true"></i>
                                nojsja
                            </span>
                            <span class="post-description">
                                <i class="fa fa-calendar" aria-hidden="true"></i>
                                2020-03-26
                            </span>
                        </span>

                        
                            <div class="blank_box"></div>
                            <span class="meta">
                                字数：<span class="post-count">2.3k</span>丨
                                阅读时间：<span class="post-count">10</span> 分钟
                            </span>
                            <div class="blank_box"></div>
                            <!-- 不蒜子统计 start -->
                            <!-- 不蒜子统计 end -->
                        

                    </div>
                

                </div>
            </div>
        </div>      
    </div>

    
    <div class="waveWrapper">
        <div class="wave wave_before" style="background-image: url('/blogs/img/wave-light.png')"></div>
        <div class="wave wave_after" style="background-image: url('/blogs/img/wave-light.png')"></div>
    </div>
    
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/blogs/">nojsja</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/blogs/">首页</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/blogs/tags/">标签</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/blogs/about/">关于</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/blogs/archive/">时间轴</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/blogs/categories/">目录</a>
                        </li>
                        
                    
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Post Content -->
<style>
    .table-responsive {
        border: none !important;
    }
</style>
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container markdown-body">

                <h3 id="目录">目录</h3>
<hr>
<ol>
<li>
<p>概述</p>
</li>
<li>
<p>文件上传-Js向中间层Node发送分片数据</p>
</li>
<li>
<p>文件上传-中间层Node接收前端发送的分片数据</p>
</li>
<li>
<p>文件下载-中间层Node获取后端文件数据的两种处理</p>
</li>
<li>
<p>文件下载-Js下载中间层文件的两种不同方式</p>
</li>
</ol>
<h3 id="预览">预览</h3>
<hr>
<p><img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="upload.png"  alt="upload"></p>
<h3 id="概述">概述</h3>
<hr>
<p>Amazon S3 提供了一个简单 Web 服务接口，可用于随时在 Web 上的任何位置存储和检索任何数量的数据。此服务让所有开发人员都能访问同一个具备高扩展性、可靠性、安全性和快速价廉的数据存储基础设施， Amazon 用它来运行其全球的网站网络。此服务旨在为开发人员带来最大化的规模效益。<br>
前一篇文章<a href="/blogs/2020/03/07/37469a41.html/">基于s3对象存储多文件分片上传的Javascript实现(一)</a>主要讲了前端Js多文件分片上传逻辑的实现，描述了浏览器端多文件分片异步上传状态管理方面的设计，这篇文章主要针对前端Coder文件操作的一些痛点，比如：前端分片是以怎样的数据形式发送到中间层的、中间层是怎样接收前端发送的分片数据的、文件下载时中间层怎样处理后端接口返回的大文件数据然后发送给前端、前端又是怎样拿到和下载中间层返回的文件数据的，主要包含这些方面。</p>
<h3 id="文件上传-Js向中间层Node发送分片数据">文件上传-Js向中间层Node发送分片数据</h3>
<hr>
<h4 id="创建Axios实例">创建Axios实例</h4>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> XHR = axios.create(&#123;</span><br><span class="line">  <span class="attr">baseURl</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">30e3</span>,</span><br><span class="line">  <span class="attr">headers</span>: originHeaders,</span><br><span class="line">  <span class="function"><span class="title">validateStatus</span>(<span class="params">status</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> status &gt;= <span class="number">200</span> &amp;&amp; status &lt; <span class="number">300</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="使用文件分片构造表单数据">使用文件分片构造表单数据</h4>
<blockquote>
<p>fileShardsData为File.slice接口对文件截取得到的部分文件数据</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = <span class="keyword">new</span> FormData();</span><br><span class="line">formData.append(<span class="string">&#x27;file&#x27;</span>, fileShardsData, <span class="string">&#x27;file&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="发送分片">发送分片</h4>
<blockquote>
<p>注意设置请求头的请求数据类型</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">XHR(&#123;</span><br><span class="line">  api,</span><br><span class="line">  method,</span><br><span class="line">  data,</span><br><span class="line">  <span class="attr">headers</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;multipart/form-data&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="文件上传-中间层Node接收前端发送的分片数据">文件上传-中间层Node接收前端发送的分片数据</h3>
<blockquote>
<p>Express没有自带文件处理功能，需要使用第三方middleware</p>
</blockquote>
<p>环境：</p>
<ul>
<li>Express V4框架</li>
<li>Node.js V8</li>
</ul>
<h4 id="方法1：使用formidable中间件处理文件请求">方法1：使用formidable中间件处理文件请求</h4>
<ol>
<li>编写公用中间处理组件</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> formidable = <span class="built_in">require</span>(<span class="string">&#x27;formidable&#x27;</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * parseFile [使用formidable进行文件解析 - 性能一般]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author <span class="variable">nojsja</span></span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>req [req obj]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>res [res obj]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="built_in">exports</span>.formidableParseFile = <span class="function">(<span class="params">req, res, callback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> form = <span class="keyword">new</span> formidable.IncomingForm();</span><br><span class="line">    form.parse(req, <span class="function">(<span class="params">err, fields, files</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (fs.existsSync(files.file.path)) &#123;</span><br><span class="line">        fs.readFile(files.file.path, <span class="function">(<span class="params">err, fileBuffer</span>) =&gt;</span> &#123;</span><br><span class="line">          fs.unlink(files.file.path, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) <span class="built_in">console</span>.log(err);</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> callback(err);</span><br><span class="line">          &#125;</span><br><span class="line">          callback(<span class="literal">null</span>, fileBuffer);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        callback(<span class="literal">null</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(error);</span><br><span class="line">    callback(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>挂载路由</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/object/object/upload&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;upload&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> random = <span class="built_in">Math</span>.random();</span><br><span class="line">  <span class="built_in">console</span>.time(<span class="string">`<span class="subst">$&#123;random&#125;</span> -&gt; 1`</span>);</span><br><span class="line">  formidableParseFile(req, res, <span class="function">(<span class="params">err, fileBuffer</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">`<span class="subst">$&#123;random&#125;</span> -&gt; 1`</span>);</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.json(&#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="number">500</span>,</span><br><span class="line">        <span class="attr">result</span>: err.toString(),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.time(<span class="string">`<span class="subst">$&#123;random&#125;</span> -&gt; 2`</span>);</span><br><span class="line">    commonRequestAuth(req.query, objectsresourceApi.object.uploadObject, req, fileBuffer).then(</span><br><span class="line">      <span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.timeEnd(<span class="string">`<span class="subst">$&#123;random&#125;</span> -&gt; 2`</span>);</span><br><span class="line">        res.json(&#123;</span><br><span class="line">          <span class="attr">code</span>: response.code,</span><br><span class="line">          <span class="attr">result</span>: &#123;</span><br><span class="line">            ...&#123; <span class="attr">etag</span>: response.headers ? response.headers.etag : <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">            ...response.result</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      );</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="方法2：代码实现文件处理">方法2：代码实现文件处理</h4>
<ol>
<li>声明方法</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * parseFile [form-data原生文件解析 - 性能差]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@author <span class="variable">nojsja</span></span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>req [req obj]</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param  <span class="type">&#123;[Object]&#125;</span> </span>res [res obj]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="built_in">exports</span>.parseFile = <span class="function">(<span class="params">req, res, callback</span>) =&gt;</span> &#123;</span><br><span class="line">  req.setEncoding(<span class="string">&#x27;binary&#x27;</span>);</span><br><span class="line">  <span class="keyword">let</span> body = <span class="string">&#x27;&#x27;</span>;   <span class="comment">// 文件数据</span></span><br><span class="line">  <span class="keyword">let</span> fileName = <span class="string">&#x27;&#x27;</span>;  <span class="comment">// 文件名</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 边界字符串</span></span><br><span class="line">  <span class="keyword">const</span> boundary = req.headers[<span class="string">&#x27;content-type&#x27;</span>].split(<span class="string">&#x27;; &#x27;</span>)[<span class="number">1</span>].replace(<span class="string">&#x27;boundary=&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  req.on(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">    body += chunk;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  req.on(<span class="string">&#x27;end&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 分隔键值对(\r\n)和键值(:)</span></span><br><span class="line">      <span class="keyword">const</span> file = querystring.parse(body, <span class="string">&#x27;\r\n&#x27;</span>, <span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">      <span class="comment">//获取文件名</span></span><br><span class="line">      <span class="keyword">const</span> fileInfo = file[<span class="string">&#x27;Content-Disposition&#x27;</span>].split(<span class="string">&#x27;; &#x27;</span>);</span><br><span class="line">      <span class="keyword">for</span> (value <span class="keyword">in</span> fileInfo) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fileInfo[value].indexOf(<span class="string">&quot;filename=&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">          fileName = fileInfo[value].substring(<span class="number">10</span>, fileInfo[value].length - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (fileName.indexOf(<span class="string">&#x27;\\&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            fileName = fileName.substring(fileName.lastIndexOf(<span class="string">&#x27;\\&#x27;</span>) + <span class="number">1</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获取图片类型(如：image/gif 或 image/png))</span></span><br><span class="line">      <span class="keyword">const</span> entireData = body.toString();</span><br><span class="line"></span><br><span class="line">      contentType = file[<span class="string">&#x27;Content-Type&#x27;</span>].substring(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//获取文件二进制数据开始位置，即contentType的结尾</span></span><br><span class="line">      <span class="keyword">const</span> upperBoundary = entireData.indexOf(contentType) + contentType.length;</span><br><span class="line">      <span class="keyword">const</span> shorterData = entireData.substring(upperBoundary);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 替换开始位置的空格</span></span><br><span class="line">      <span class="keyword">const</span> binaryDataAlmost = shorterData.replace(<span class="regexp">/^\s\s*/</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="regexp">/\s\s*$/</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 去除数据末尾的额外数据，即: &quot;--&quot;+ boundary + &quot;--&quot;</span></span><br><span class="line">      <span class="keyword">const</span> binaryData = binaryDataAlmost.substring(<span class="number">0</span>, binaryDataAlmost.indexOf(<span class="string">&#x27;--&#x27;</span> + boundary + <span class="string">&#x27;--&#x27;</span>));</span><br><span class="line"></span><br><span class="line">      callback(<span class="literal">null</span>, binaryData);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      callback(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;form-data parse error!&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>挂载路由同上</li>
</ol>
<h3 id="文件下载-中间层Node获取后端文件数据的两种处理">文件下载-中间层Node获取后端文件数据的两种处理</h3>
<hr>
<blockquote>
<p>两种方式均使用Axios发送请求</p>
</blockquote>
<h4 id="小文件直传">小文件直传</h4>
<p>接收到接口数据后直接放入内存然后以文件的类型发送给前端</p>
<ol>
<li>请求header注意设置<code>resType: &quot;arraybuffer&quot;</code></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对象详情信息</span></span><br><span class="line">router.post(<span class="string">&#x27;/resource/object/detailinfo/all&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  commonRequestAuth(&#123; ...req.body, ...&#123; <span class="attr">$no_timeout$</span>: <span class="literal">true</span> &#125;&#125;, objectsresourceApi.object.objectinfoAll, req).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    res.type(<span class="string">&#x27;file&#x27;</span>).send(response.result)</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="大文件转存为静态资源">大文件转存为静态资源</h4>
<blockquote>
<p>Node.js支持文件流操作，包含可读流、可写流以及可读可写流，如果在处理大文件的时候直接把数据放入内存，就会出现中间层内存爆满的情况，这里先声明接口返回数据为可读流，然后通过本地静态资源路径创建可写流，最后为了避免由于可读流的数据写入可写流时由于读取速度和写入速度的差异问题导致的数据丢失情况，使用管道pipe连接可读流和可写流再进行数据传输。</p>
</blockquote>
<ol>
<li>
<p>Node Pipe管道的概念<br>
<img   src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" lazyload data-loading="/blogs/img/loading.gif" data-src="node_pipe.png"  alt="node pipe"></p>
</li>
<li>
<p>请求header注意设置<code>resType: &quot;stream&quot;</code></p>
</li>
<li>
<p>创建本地可写流<br>
使用fs.createWriteStream接口，参数为本地某个目录文件，文件可以不存在，目录需要实际存在</p>
</li>
<li>
<p>接口返回的是可读流，可以直接连接到管道<br>
注意服务器是否支持以数据流方式返回二进制数据</p>
</li>
<li>
<p>可写流完成写入后向前端发送静态资源文件地址<br>
监听可写流的finish事件可以异步处理文件完成写入事件</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对象详情信息</span></span><br><span class="line">router.post(<span class="string">&#x27;/resource/object/detailinfo&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;download&#x27;</span>);</span><br><span class="line">  commonRequestAuth(&#123; ...req.body, ...&#123; <span class="attr">$no_timeout$</span>: <span class="literal">true</span> &#125;&#125;, objectsresourceApi.object.objectinfo, req).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;download callback&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> fileName = req.body.object.split(<span class="string">&#x27;/&#x27;</span>).pop();</span><br><span class="line">    <span class="keyword">const</span> fileSymbol = <span class="string">`<span class="subst">$&#123;fileName&#125;</span>-<span class="subst">$&#123;<span class="built_in">Date</span>.now()&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">const</span> filePath = path.join(_path.public, <span class="string">&#x27;download&#x27;</span>, fileSymbol);</span><br><span class="line">    <span class="keyword">const</span> ws = fs.createWriteStream(filePath);</span><br><span class="line">    response.result.pipe(ws);</span><br><span class="line">    ws.on(<span class="string">&#x27;finish&#x27;</span>, <span class="function">() =&gt;</span> &#123; </span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;download finish&#x27;</span>);</span><br><span class="line">      res.header(&#123;</span><br><span class="line">        <span class="string">&#x27;Content-Disposition&#x27;</span>: fileName</span><br><span class="line">      &#125;);</span><br><span class="line">      res.json(&#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">result</span>: filePath.split(<span class="string">&#x27;node-express-react/public/public&#x27;</span>)[<span class="number">1</span>],</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;); </span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="文件下载-Js下载中间层文件的两种不同方式">文件下载-Js下载中间层文件的两种不同方式</h3>
<hr>
<h4 id="小文件直接从接口拿到数据并生成DataURL触发下载">小文件直接从接口拿到数据并生成DataURL触发下载</h4>
<ol>
<li>
<p>请求header声明<code>responseType:arraybuffer</code><br>
指名返回的数据是可直接使用的二进制流数据</p>
</li>
<li>
<p>接口数据返回后生成前端通用的大二进制块数据<code>Blob</code><br>
new Blob(DataArray, { type: mimetype })，mimetype需要正确指定，比如jpeg格式的图片mimetype为image/jpeg</p>
</li>
<li>
<p>使用HTML5 FileReader接口读取二进制块<br>
reader.readAsDataURL将二进制读取为base64编码的字符串数据，前端可以直接预览和下载此类DataURL</p>
</li>
<li>
<p>构造a标签并指名download属性下载DataURL<br>
替代方法是使用window.open(dataUrl)</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">downloadObjectInMemory = <span class="function">(<span class="params">para, info</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> iAxios = axios.create();</span><br><span class="line">    <span class="comment">// iAxios.defaults.timeout = 60 * 1000 * 60 * 10;</span></span><br><span class="line">    iAxios.defaults.timeout = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> options = &#123;</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;/resource/object/detailinfo/all&#x27;</span>,</span><br><span class="line">      <span class="attr">withCredentials</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">responseType</span>: <span class="string">&#x27;arraybuffer&#x27;</span>,</span><br><span class="line">      <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Cache-Control&#x27;</span>: <span class="string">&#x27;max-age=0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;X-Requested-With&#x27;</span>: <span class="string">&#x27;XMLHttpRequest&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>: <span class="string">&#x27;*&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">data</span>: para,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> readAsDataUrl = <span class="function">(<span class="params">data, emptyData</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">      reader.readAsDataURL(data);</span><br><span class="line">      reader.onload = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> url = e.target.result;</span><br><span class="line">        <span class="keyword">const</span> a = <span class="built_in">document</span>.createElement(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> filename = para.object.split(<span class="string">&#x27;/&#x27;</span>).pop();</span><br><span class="line">        a.href = url === <span class="string">&#x27;data:&#x27;</span> ? emptyData : url;</span><br><span class="line">        a.download = filename;</span><br><span class="line">        a.click();</span><br><span class="line">        <span class="built_in">window</span>.URL.revokeObjectURL(url);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> typename = mapMimeType(info.name).mime;</span><br><span class="line">    iAxios.request(options)</span><br><span class="line">      .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> blobData = <span class="keyword">new</span> Blob([res.data], &#123; <span class="attr">type</span>: typename &#125;);</span><br><span class="line">        readAsDataUrl(blobData, <span class="string">`data:<span class="subst">$&#123;typename&#125;</span>;base64,`</span>);</span><br><span class="line">      &#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="大文件通过接口返回的静态文件链接进行下载">大文件通过接口返回的静态文件链接进行下载</h4>
<p>步骤同上，只不过构造DataURL的过程取消，a标签可以直接使用接口返回的静态文件地质URL</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">downloadObjectWithURL = <span class="function">(<span class="params">para</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> iAxios = axios.create();</span><br><span class="line">    <span class="comment">// iAxios.defaults.timeout = 60 * 1000 * 60 * 10;</span></span><br><span class="line">    iAxios.defaults.timeout = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> options = &#123;</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&#x27;/resource/object/detailinfo&#x27;</span>,</span><br><span class="line">      <span class="attr">withCredentials</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">responseType</span>: <span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">      <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Cache-Control&#x27;</span>: <span class="string">&#x27;max-age=0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;X-Requested-With&#x27;</span>: <span class="string">&#x27;XMLHttpRequest&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>: <span class="string">&#x27;*&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">data</span>: para,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> timer;</span><br><span class="line">    iAxios.request(options)</span><br><span class="line">      .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">        <span class="keyword">const</span> a = <span class="built_in">document</span>.createElement(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> filename = para.object.split(<span class="string">&#x27;/&#x27;</span>).pop();</span><br><span class="line">        <span class="keyword">const</span> address = process.env.NODE_ENV === <span class="string">&#x27;development&#x27;</span> ? <span class="string">`<span class="subst">$&#123;<span class="built_in">window</span>.location.protocol&#125;</span>//10.0.6.206:3000<span class="subst">$&#123;res.data.result&#125;</span>`</span> : <span class="string">`<span class="subst">$&#123;<span class="built_in">window</span>.location.protocol&#125;</span>//<span class="subst">$&#123;<span class="built_in">window</span>.location.hostname&#125;</span>:3000<span class="subst">$&#123;res.data.result&#125;</span>`</span>;</span><br><span class="line">        a.href = address;</span><br><span class="line">        a.download = filename;</span><br><span class="line">        a.click();</span><br><span class="line">      &#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(error);</span><br><span class="line">      &#125;);</span><br><span class="line">    timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      openNotification(<span class="string">&#x27;info&#x27;</span>, <span class="literal">null</span>, <span class="built_in">this</span>.lang.lang.fileDownloadTips);</span><br><span class="line">    &#125;, <span class="number">1e3</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

                <!-- 不蒜子统计 start -->
                <span class="meta" id="headerViewCountWrapper">
                    <!-- Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times -->
                    <span id="<Your/Path/Name>" class="leancloud_visitors" data-flag-title="Your Article Title">
                        <em class="post-meta-item-text">⇸⇸ 阅读量：</em>
                        <i class="leancloud-visitors-count">[ loading ]</i>⇷⇷
                    </span>
                </span>
                <script>
                    document.querySelector('#headerViewCountWrapper > .leancloud_visitors').id = decodeURIComponent(window.location.pathname);
                </script>
                <!-- 不蒜子统计 end -->
                
                <hr style="margin-top: 5px;">

                <!-- Pager -->
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/blogs/2020/04/16/a493952e.html/" data-toggle="tooltip" data-placement="top" title="前端浏览器开发工具">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/blogs/2020/03/22/39caa941.html/" data-toggle="tooltip" data-placement="top" title="echarts图表-树形图开发记录">Next Post &rarr;</a>
                    </li>
                    
                </ul>


                <!-- tip start -->
                


                <!-- Music start-->
                
                <!-- Loading CSS -->
<style type="text/css">
    .aplayer-container {
        text-align: center;
    }

    .lds-roller-loading {
        display: inline-block;
        position: relative;
        width: 80px;
        height: 80px;
    }

    .lds-roller-loading div {
        animation: lds-roller 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        transform-origin: 40px 40px;
    }

    .lds-roller-loading div:after {
        content: " ";
        display: block;
        position: absolute;
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: #ff59ac;
        margin: -4px 0 0 -4px;
    }

    .lds-roller-loading div:nth-child(1) {
        animation-delay: -0.036s;
    }

    .lds-roller-loading div:nth-child(1):after {
        top: 63px;
        left: 63px;
    }

    .lds-roller-loading div:nth-child(2) {
        animation-delay: -0.072s;
    }

    .lds-roller-loading div:nth-child(2):after {
        top: 68px;
        left: 56px;
    }

    .lds-roller-loading div:nth-child(3) {
        animation-delay: -0.108s;
    }

    .lds-roller-loading div:nth-child(3):after {
        top: 71px;
        left: 48px;
    }

    .lds-roller-loading div:nth-child(4) {
        animation-delay: -0.144s;
    }

    .lds-roller-loading div:nth-child(4):after {
        top: 72px;
        left: 40px;
    }

    .lds-roller-loading div:nth-child(5) {
        animation-delay: -0.18s;
    }

    .lds-roller-loading div:nth-child(5):after {
        top: 71px;
        left: 32px;
    }

    .lds-roller-loading div:nth-child(6) {
        animation-delay: -0.216s;
    }

    .lds-roller-loading div:nth-child(6):after {
        top: 68px;
        left: 24px;
    }

    .lds-roller-loading div:nth-child(7) {
        animation-delay: -0.252s;
    }

    .lds-roller-loading div:nth-child(7):after {
        top: 63px;
        left: 17px;
    }

    .lds-roller-loading div:nth-child(8) {
        animation-delay: -0.288s;
    }

    .lds-roller-loading div:nth-child(8):after {
        top: 56px;
        left: 12px;
    }

    @keyframes lds-roller {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .aplayer .aplayer-pic .aplayer-pause svg {
        top: 0px;
        left: 0px;
    }

    .aplayer .aplayer-pic .aplayer-play svg {
        top: 0px;
        left: 2px;
    }
</style>

<!-- HTML -->

<div class="aplayer-container">
    <div id="aplayer"
         class="lds-roller-loading"
         lazy-css-href="https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.css"
         lazy-js-src="https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.js"
    >
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
    </div>
</div>

<!-- Main Script -->
<script>

    (function() {
        var musicPlayer = document.querySelector('#aplayer');
        var apobserver;
    
        /* load player */
        var apcallback = function () {
            if (apobserver) apobserver.disconnect();
            musicPlayer.className = "";
            musicPlayer.innerHTML = "";
            var ap = new APlayer({
                container: document.getElementById('aplayer'),
                theme: '#e9e9e9',
                audio: [{
                    name: '存在信号',
                    artist: 'AcuticNotes',
                    url: 'http://nojsja.gitee.io/static-resources/audio/life-signal.mp3',
                    cover: 'http://nojsja.gitee.io/static-resources/audio/life-signal.jpg'
    
                }, {
                    name: '遺サレタ場所／斜光',
                    artist: '岡部啓一',
                    url: 'http://nojsja.gitee.io/static-resources/audio/%E6%96%9C%E5%85%89.mp3',
                    cover: 'http://nojsja.gitee.io/static-resources/audio/%E6%96%9C%E5%85%89.jpg'
                }]
            });
        };
    
        /* get player resources */
        var apinit = function (cssHref, jsSrc) {
            var sources = [];
            cssHref && (sources.push(cssHref));
            jsSrc && (sources.push(jsSrc));
    
            sources.forEach(function (source) {
                async(source, function () {
                    if (/^.*.js$/.test(source)) {
                        apcallback();
                    }
                }, /^.*.css$/.test(source) ? 'link' : 'script');
            });
    
        }
    
    
        /* scroll listener */
        if (window.IntersectionObserver) {
    
            apobserver = new IntersectionObserver(function (entrys) {
    
                entrys.forEach(function (entry) {
                    if (!entry.isIntersecting) return;
                    apobserver.unobserve(entry.target);
    
                    var sources = [];
                    var cssHref = entry.target.getAttribute('lazy-css-href');
                    var jsSrc = entry.target.getAttribute('lazy-js-src');
    
                    apinit(cssHref, jsSrc);
    
                });
            });
    
            apobserver.observe(musicPlayer);
    
        } else {
    
            var cssHref = musicPlayer.getAttribute('lazy-css-href');
            var jsSrc = musicPlayer.getAttribute('lazy-js-src');
    
            apinit(cssHref, jsSrc);
    
        }

    }.bind(window))();

</script>
                
                <!-- Music end -->

                <!-- Sharing -->
                
                <!-- Sharing -->

                <!-- comment start -->
                
                <hr>
                
<div id="vcomments"></div>
<script>
    (function() {

        /* 初始化 comments 组件 */
        function initComments() {
            async('/blogs/js/Valine.min.js', function () {
                new Valine({
                    el: '#vcomments',
                    appId: "wUKKBx8BRzGaNfhgdg2UKtub-MdYXbMMI",
                    appKey: "MAwYM4KlW5YJ3q06qwnUScBr",
                    visitor: true
                });
            });
        }

        /* scroll listener */
        if (window.IntersectionObserver) {
    
            var vobserver = new IntersectionObserver(function (entrys) {
    
                entrys.forEach(function (entry) {
                    if (!entry.isIntersecting) return;
                    vobserver.unobserve(entry.target);
                    vobserver.disconnect();
                    initComments();
                });
            });
    
            vobserver.observe(document.querySelector('#headerViewCountWrapper'));
    
        } else {

            initComments();

        }
        
    }).bind(window)();
</script>
                
                <!-- comment end -->
            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      
        <aside id="sidebar">
          <div id="toc" class="toc-article">
          <strong class="toc-title">Contents</strong>
          
            
              <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">目录</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E9%A2%84%E8%A7%88"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">预览</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">概述</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0-Js%E5%90%91%E4%B8%AD%E9%97%B4%E5%B1%82Node%E5%8F%91%E9%80%81%E5%88%86%E7%89%87%E6%95%B0%E6%8D%AE"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">文件上传-Js向中间层Node发送分片数据</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%9B%E5%BB%BAAxios%E5%AE%9E%E4%BE%8B"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">创建Axios实例</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%87%E4%BB%B6%E5%88%86%E7%89%87%E6%9E%84%E9%80%A0%E8%A1%A8%E5%8D%95%E6%95%B0%E6%8D%AE"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">使用文件分片构造表单数据</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%8F%91%E9%80%81%E5%88%86%E7%89%87"><span class="toc-nav-number">4.3.</span> <span class="toc-nav-text">发送分片</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0-%E4%B8%AD%E9%97%B4%E5%B1%82Node%E6%8E%A5%E6%94%B6%E5%89%8D%E7%AB%AF%E5%8F%91%E9%80%81%E7%9A%84%E5%88%86%E7%89%87%E6%95%B0%E6%8D%AE"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">文件上传-中间层Node接收前端发送的分片数据</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%96%B9%E6%B3%951%EF%BC%9A%E4%BD%BF%E7%94%A8formidable%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%A4%84%E7%90%86%E6%96%87%E4%BB%B6%E8%AF%B7%E6%B1%82"><span class="toc-nav-number">5.1.</span> <span class="toc-nav-text">方法1：使用formidable中间件处理文件请求</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%96%B9%E6%B3%952%EF%BC%9A%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86"><span class="toc-nav-number">5.2.</span> <span class="toc-nav-text">方法2：代码实现文件处理</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD-%E4%B8%AD%E9%97%B4%E5%B1%82Node%E8%8E%B7%E5%8F%96%E5%90%8E%E7%AB%AF%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE%E7%9A%84%E4%B8%A4%E7%A7%8D%E5%A4%84%E7%90%86"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">文件下载-中间层Node获取后端文件数据的两种处理</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%B0%8F%E6%96%87%E4%BB%B6%E7%9B%B4%E4%BC%A0"><span class="toc-nav-number">6.1.</span> <span class="toc-nav-text">小文件直传</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%A4%A7%E6%96%87%E4%BB%B6%E8%BD%AC%E5%AD%98%E4%B8%BA%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90"><span class="toc-nav-number">6.2.</span> <span class="toc-nav-text">大文件转存为静态资源</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD-Js%E4%B8%8B%E8%BD%BD%E4%B8%AD%E9%97%B4%E5%B1%82%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%A4%E7%A7%8D%E4%B8%8D%E5%90%8C%E6%96%B9%E5%BC%8F"><span class="toc-nav-number">7.</span> <span class="toc-nav-text">文件下载-Js下载中间层文件的两种不同方式</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%B0%8F%E6%96%87%E4%BB%B6%E7%9B%B4%E6%8E%A5%E4%BB%8E%E6%8E%A5%E5%8F%A3%E6%8B%BF%E5%88%B0%E6%95%B0%E6%8D%AE%E5%B9%B6%E7%94%9F%E6%88%90DataURL%E8%A7%A6%E5%8F%91%E4%B8%8B%E8%BD%BD"><span class="toc-nav-number">7.1.</span> <span class="toc-nav-text">小文件直接从接口拿到数据并生成DataURL触发下载</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%A4%A7%E6%96%87%E4%BB%B6%E9%80%9A%E8%BF%87%E6%8E%A5%E5%8F%A3%E8%BF%94%E5%9B%9E%E7%9A%84%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E9%93%BE%E6%8E%A5%E8%BF%9B%E8%A1%8C%E4%B8%8B%E8%BD%BD"><span class="toc-nav-number">7.2.</span> <span class="toc-nav-text">大文件通过接口返回的静态文件链接进行下载</span></a></li></ol></li></ol>
            
          
          </div>
        </aside>
      
    

        </div>
    </div>
</article>


    <!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
  async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
      anchors.options = {
        visible: 'hover',
        placement: 'left',
        icon: 'ℬ'
      };
      anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  })
</script>

<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<!-- 文章导航条fixed自动定位 -->
<script type="text/javascript" src="/blogs/js/anchor.nojsja.js"></script>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">

                
                    <li>
                        <a target="_blank" rel="noopener external nofollow noreferrer"  href="https://github.com/nojsja">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                

                

                

                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; nojsja 2021 
                </p>
            </div>
        </div>
    </div>

</footer>

<!-- jQuery -->
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>

<!-- Js Widgets -->

<script src="/blogs/js/widgets.js"></script>



<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Search -->

    <script type="text/javascript">      
        var search_path = "search.xml";
        if (search_path.length == 0) {
            search_path = "search.xml";
        }
    var path = "/blogs/" + search_path;
    searchFunc(path, 'local-search-input', 'local-search-result');
    </script>


<!-- busuanzi -->
<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->

<script src="/blogs/js/busuanzi.pure.mini.js" defer async></script>






	<a id="rocket" href="#top" class=""></a>
    
	<script type="text/javascript" src="/blogs/js/totop.js" async=""></script>
<!-- hexo injector body_end start -->
    <script>
      
(function() {
  /* avoid garbage collection */
  window.hexoLoadingImages = window.hexoLoadingImages || {};

  function query(selector) {
    return document.querySelectorAll(selector);
  }
  
  /* registry listener */
  if (window.IntersectionObserver) {
  
    var observer = new IntersectionObserver(function (entries) {

      entries.forEach(function (entry) {
        // in view port
        if (entry.isIntersecting) {
          observer.unobserve(entry.target);

          // proxy image
          var img = new Image();
          var imgId = "_img_" + Math.random();
          window.hexoLoadingImages[imgId] = img;

          img.onload = function() {
            entry.target.src = entry.target.getAttribute('data-src');
            window.hexoLoadingImages[imgId] = null;
          };
          img.onerror = function() {
            window.hexoLoadingImages[imgId] = null;
          }

          entry.target.src = entry.target.getAttribute('data-loading');
          img.src = entry.target.getAttribute('data-src');

        }
      });
    });
    
    query('img[lazyload]').forEach(function (item) {
      observer.observe(item);
    });
  
  } else {
  /* fallback */
    query('img[lazyload]').forEach(function (img) {
      img.src = img.getAttribute('data-src');
    });
  
  }
}).bind(window)();
    </script><!-- hexo injector body_end end --></body>

</html>
